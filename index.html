<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>è¿›åº¦æ¡ + Logo äº’åŠ¨é¡µé¢</title>

<!-- è¿›åº¦æ¡ & æŒ‰é’®æ ·å¼ -->
<style>
    body {
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
        background: #f5f5f5;
    }

    img {
        width: 200px;
        transition: opacity 0.5s;
        margin-bottom: 30px;
    }

    .progress-container {
        width: 80%;
        background: #ddd;
        border-radius: 10px;
        height: 25px;
        overflow: hidden;
        margin-bottom: 30px;
    }

    .progress-bar {
        height: 25px;
        width: 0%;
        background: #007bff;
        transition: width 0.5s;
    }

    button {
        padding: 15px 40px;
        border: none;
        border-radius: 10px;
        background: #007bff;
        color: white;
        font-size: 18px;
        cursor: pointer;
        transition: opacity 0.3s;
    }

    button:disabled {
        background: #888;
        cursor: not-allowed;
    }
</style>
</head>
<body>

<!-- logo -->
<img id="logo" src="img/logo.svg" style="opacity: 0.1;">

<!-- è¿›åº¦æ¡ -->
<div class="progress-container">
    <div id="progressBar" class="progress-bar"></div>
</div>

<!-- æŒ‰é’® -->
<button id="actionBtn">ç‚¹æˆ‘ +1</button>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore-compat.js"></script>

<script>
/*** âœ… â‘  åˆå§‹åŒ– Firebase é…ç½®ï¼ˆæ¢æˆä½ è‡ªå·±çš„ï¼‰ ***/
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "xxxxxx",
    appId: "xxxxxx"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const TARGET = 100; // âœ… è®¾ç½®ç›®æ ‡æ¬¡æ•°

const progressBar = document.getElementById("progressBar");
const button = document.getElementById("actionBtn");
const logo = document.getElementById("logo");

let userIP = "";
let clicked = false;

/*** âœ… â‘¡ è·å–ç”¨æˆ·IP ***/
fetch("https://api.ipify.org?format=json")
    .then(res => res.json())
    .then(data => {
        userIP = data.ip;
        checkIP();
    });

/*** âœ… æŸ¥è¯¢ Firestore æ˜¯å¦å·²ç»ç‚¹è¿‡ ***/
function checkIP() {
    db.collection("clickUsers").doc(userIP).get().then(doc => {
        if (doc.exists) {
            disableButton();
        }
    });

    updateProgress();
}

/*** âœ… æ›´æ–°è¿›åº¦æ¡å’Œ logo é€æ˜åº¦ ***/
function updateProgress() {
    db.collection("counter").doc("global")
        .onSnapshot(doc => {
            let count = doc.data()?.count || 0;
            let percent = Math.min((count / TARGET) * 100, 100);

            progressBar.style.width = percent + "%";
            logo.style.opacity = (percent / 100);

            if (percent >= 100) {
                disableButton(true);
            }
        });
}

/*** âœ… ç‚¹å‡»æŒ‰é’®äº‹ä»¶ ***/
button.addEventListener("click", async () => {

    // é˜²æ­¢é‡å¤è§¦å‘
    if (clicked) return;
    clicked = true;

    // IP å†™å…¥æ•°æ®åº“ï¼ˆè®°å½•ç”¨æˆ·æŒ‰è¿‡ï¼‰
    await db.collection("clickUsers").doc(userIP).set({ clicked: true });

    // è®¡æ•° +1ï¼ˆä½¿ç”¨äº‹åŠ¡é¿å…å†²çªï¼‰
    const counter = db.collection("counter").doc("global");
    await counter.set({ count: firebase.firestore.FieldValue.increment(1) }, { merge: true });

    disableButton();
});

/*** âœ… æŒ‰é’®ç¦ç”¨ + ä¿®æ”¹æ–‡å­— ***/
function disableButton(isComplete = false) {
    button.disabled = true;
    button.style.opacity = 0.5;
    button.innerText = isComplete ? "å®Œæˆ ğŸ‰" : "å·²å‚ä¸ âœ…";
}
</script>

</body>
</html>
